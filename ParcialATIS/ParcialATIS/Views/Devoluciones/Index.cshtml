@model ParcialATIS.Models.DevolucionViewModel

@{
    ViewData["Title"] = "Devolución de Auto";
}

<div class="container mt-5">
    <h2>Devolución de Auto</h2>
    <hr />
    <form method="post" action="/Devolucion/Devolver">
        <div class="form-group">
            <label for="cliente">Seleccionar Cliente:</label>
            <select class="form-control" name="clienteId" id="cliente">
                <option value="">Seleccione un cliente</option>

                <!-- Aquí se verifica si hay clientes disponibles -->
                @if (Model.Clientes != null && Model.Clientes.Any())
                {
                    @foreach (var cliente in Model.Clientes)
                    {
                        <option value="@cliente.IdCliente">@cliente.Nombre</option>
                    }
                }
                else
                {
                    <option value="">No hay clientes disponibles</option>
                }
            </select>
        </div>

        <!-- Aquí se mostrarán los autos alquilados del cliente seleccionado -->
        <div id="autosContainer" style="display:none;">
            <div class="form-group">
                <label for="auto">Seleccionar Auto a Devolver:</label>
                <select class="form-control" name="idAuto" id="auto">
                    <option value="">Seleccione un auto</option>
                    @foreach (var auto in Model.AutosAlquilados)
                    {
                        <option value="@auto.IdAuto">@auto.Marca @auto.Modelo (@auto.Placa)</option>
                    }
                </select>
            </div>
        </div>

        <input type="hidden" name="clienteId" value="@Model.ClienteId" />
        <button type="submit" class="btn btn-success mt-3" id="devolverBtn" style="display:none;">Devolver Auto</button>
    </form>
</div>

<script>
    // Usamos JavaScript para cargar los autos alquilados cuando se selecciona un cliente
    document.getElementById("cliente").addEventListener("change", function () {
        var clienteId = this.value;

        // Si el cliente ha sido seleccionado
        if (clienteId) {
            // Realizamos una solicitud AJAX para obtener los autos alquilados por ese cliente
            fetch(`/Devolucion/ObtenerAutosAlquilados?clienteId=${clienteId}`)
                .then(response => response.json())
                .then(data => {
                    var autosSelect = document.getElementById("auto");
                    autosSelect.innerHTML = "<option value=''>Seleccione un auto</option>"; // Limpiamos el select de autos

                    // Rellenamos el select con los autos alquilados
                    data.forEach(auto => {
                        var option = document.createElement("option");
                        option.value = auto.idAuto;
                        option.textContent = `${auto.marca} ${auto.modelo} (${auto.placa})`;
                        autosSelect.appendChild(option);
                    });

                    // Mostramos el contenedor de autos y el botón para devolver
                    document.getElementById("autosContainer").style.display = "block";
                    document.getElementById("devolverBtn").style.display = "inline-block";
                })
                .catch(error => {
                    console.error("Error al obtener los autos alquilados:", error);
                });
        } else {
            // Si no se ha seleccionado un cliente, ocultamos los autos y el botón
            document.getElementById("autosContainer").style.display = "none";
            document.getElementById("devolverBtn").style.display = "none";
        }
    });
</script>
